// Takes the downloaded components JSON Schema and transforms it into TS types
// The generated file is at cms/storyblok/types/storyblok.gen.d.ts

// https://nodejs.org/docs/latest-v20.x/api/process.html#processloadenvfilepath
process.loadEnvFile('.env.storyblok')

const path = require('node:path')
const fs = require('node:fs')
const storyblokToTypescript =
  require('storyblok-generate-ts/dist/index').default

const root = process.cwd()

const schemaFile = path.join(
  root,
  `components.${process.env.STORYBLOK_SPACE_ID}.json`,
)
const outputFile = path.join(
  root,
  'modules',
  'cms',
  'providers',
  'storyblok',
  'types',
  'storyblok.gen.d.ts',
)

storyblokToTypescript({
  componentsJson: require(schemaFile),
  path: outputFile,
  titlePrefix: 'Sb',
  titleSuffix: '',
  compilerOptions: {
    unknownAny: true,
    additionalProperties: false,
    bannerComment: `
        /* eslint-disable */
        /**
         * This type/interface was automatically generated by the storyblok:generate command.
         * DO NOT MODIFY IT BY HAND. Instead, download the schema from storyblok (storyblok:download),
         * and run storyblok:generate to regenerate this file.
        */`.trim(),
    unreachableDefinitions: true,
  },
  // Support the SEO plugin
  customTypeParser(key, obj) {
    switch (obj.field_type) {
      case 'seo-metatags':
        return {
          [key]: {
            type: 'object',
            properties: {
              _uid: {
                type: 'string',
              },
              title: {
                type: 'string',
              },
              plugin: {
                type: 'string',
              },
              og_image: {
                type: 'string',
              },
              og_title: {
                type: 'string',
              },
              description: {
                type: 'string',
              },
              twitter_image: {
                type: 'string',
              },
              twitter_title: {
                type: 'string',
              },
              og_description: {
                type: 'string',
              },
              twitter_description: {
                type: 'string',
              },
            },
          },
        }
      case 'scayle-plugin':
      case 'scayle-plugin2':
        return {
          [key]: {
            type: 'array',
            items: {
              type: 'object',
              properties: {
                id: {
                  type: 'string',
                },
                referenceKey: {
                  type: 'string',
                },
                name: {
                  type: 'string',
                },
                imageUrl: {
                  type: 'string',
                },
              },
            },
          },
        }
      default:
        return {}
    }
  },
}).then(() => {
  const fileContent = fs.readFileSync(outputFile, { encoding: 'utf8' })

  fs.writeFileSync(outputFile, `/* eslint-disable */\n` + fileContent, {
    encoding: 'utf8',
  })
})
